# ===================================================
# mounts
# ===================================================
mount=torizon-build-dir:
    bind: build/torizon
    path: /workdir

# ===================================================
# images
# ===================================================
image=image-torizon-builder:
    image: ci4rail/torizon-builder
    context: torizon-builder/docker
    tags: [ "{env.GitVersion_BranchVersion}" ]
    annotations:
      description: "build image-torizon-builder"

# ===================================================
# jobs
# ===================================================
job=prepare-build-torizon-core-docker:
    use: image-torizon-builder
    command: /usr/local/bin/prepare.sh
    mounts: 
        - torizon-build-dir
    working-dir: /workdir
    env:
        - USERID={user.uid}    
        - WORK_DIR=/workdir
        - BUILD_DIR=build-torizon
        - DISTRIBUTION=torizon
        - BRANCH=zeus
        - MACHINE=verdin-imx8mm
        - MANIFEST_REPO=https://github.com/ci4rail/toradex-torizon-manifest

job=build-torizon-core-docker:
    use: image-torizon-builder
    command: /usr/local/bin/build.sh
    mounts: 
        - torizon-build-dir
    env:
        - USERID={user.uid}
        - WORK_DIR=/workdir
        - DISTRIBUTION=torizon
        - MACHINE=verdin-imx8mm
        - TARGET=torizon-core-docker
    sources: 
        - build/torizon/torizon/layers/
    artifact: 
        - build/torizon/torizon/build-torizon/deploy/images/verdin-imx8mm/


job=bash-torizon-core-docker:
    use: image-torizon-builder
    command: bash -c 'cd ${WORK_DIR}/${DISTRIBUTION} && . ./setup-environment; bash'
    mounts: 
        - torizon-build-dir 
    interactive: true
    env:
        - USERID={user.uid}
        - WORK_DIR=/workdir
        - DISTRIBUTION=torizon
        - MACHINE=verdin-imx8mm
        - TARGET=torizon-core-docker
    annotations:
      description: "interactive shell for building torizon-core-docker"      