# ===================================================
# mounts
# ===================================================
mount=torizon-work-dir:
    bind: build/torizon-work
    path: /workdir

mount=torizon-build-dir:
    bind: build/torizon-build
    path: /build

mount=torizon-install-dir:
    bind: install/torizon
    path: /install

# ===================================================
# images
# ===================================================
image=image-torizon-builder:
    image: ci4rail/torizon-builder
    context: torizon-builder
    tags: [ "{env.GitVersion_BranchVersion}" ]
    annotations:
      description: "build image-torizon-builder"

# ===================================================
# jobs
# ===================================================
job=prepare-build:
    use: image-torizon-builder
    # command: /usr/local/bin/prepare.sh
    command: bash
    mounts: 
        - torizon-build-dir
        - torizon-work-dir
    working-dir: /workdir
    env:
        - USERID={user.uid}    
        - WORK_DIR=/workdir
        - BUILDDIR=/build
        - DL_DIR=/download
        - SSTATE_DIR=/sstate-cache
        - BUILD_DIR=build-torizon
        - DISTRIBUTION=torizon
        - BRANCH=zeus
        - MACHINE=verdin-imx8mm
        - MANIFEST_REPO=https://github.com/ci4rail/toradex-torizon-manifest

job=build-torizon-core-docker:
    use: image-torizon-builder
    command: /usr/local/bin/build.sh
    depends: 
        - prepare-build
    mounts: 
        - torizon-build-dir
        - torizon-work-dir
    sources: 
        - build/torizon/torizon/layers/*
    artifact: 
        - ${WORK_DIR}/${DISTRIBUTION}/${BUILD_DIR}/deploy/images/${MACHINE}/*
    env:
        - USERID={user.uid}
        - WORK_DIR=/workdir
        - DISTRIBUTION=torizon
        - MACHINE=verdin-imx8mm
        - TARGET=torizon-core-docker

job=install-torizon-core-docker:
    use: image-torizon-builder
    command: bash -c "cp -rv ${WORK_DIR}/${DISTRIBUTION}/${BUILD_DIR}/deploy/images/${MACHINE}/ /install"
    depends: 
        - build-torizon-core-docker
    mounts: 
        - torizon-work-dir
        - torizon-build-dir
        - torizon-install-dir
    sources: 
        - ${WORK_DIR}/${DISTRIBUTION}/${BUILD_DIR}/deploy/images/${MACHINE}/*
    artifact: 
        - /install/*
    env:
        - USERID={user.uid}    
        - WORK_DIR=/workdir
        - BUILD_DIR=build-torizon
        - DISTRIBUTION=torizon
        - MACHINE=verdin-imx8mm

job=bash-torizon-core-docker:
    use: image-torizon-builder
    # command: bash -c 'cd ${WORK_DIR}/${DISTRIBUTION} && . ./setup-environment; bash'
    command: bash
    mounts: 
        - torizon-work-dir
        - torizon-build-dir 
        - torizon-install-dir
    interactive: true
    env:
        - USERID={user.uid}
        - WORK_DIR=/workdir
        # - BUILDDIR=/build
        - BUILD_DIR=build-torizon
        - DISTRIBUTION=torizon
        - MACHINE=verdin-imx8mm
        - TARGET=torizon-core-docker
    annotations:
      description: "interactive shell for building torizon-core-docker"      